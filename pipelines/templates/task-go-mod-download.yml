---
parameters:
  - name: workingDirectory
    type: string
    default: $(Build.SourcesDirectory)
steps:
  ####################
  # Windows Specific #
  ####################
  # The paths are different and the joining, so just seperating.
  - pwsh: |
      $ENV:PATH = '$(Build.SourcesDirectory)/.cache/aqua/bin', $ENV:PATH -join [IO.Path]::PathSeparator
       Write-Host ('[go] binary: {0} version: {1}' -f $(Get-Command go -ErrorAction SilentlyContinue).Path, [string]$(go version)) -ForegroundColor Gray
       go mod download -x
    displayName: go-mod-download
    workingDirectory: ${{ parameters.WorkingDirectory }}
    failOnStderr: false

  - pwsh: |
      $ENV:PATH = '$(Build.SourcesDirectory)/.cache/aqua/bin', $ENV:PATH -join [IO.Path]::PathSeparator
       Write-Host ('[go] binary: {0} version: {1}' -f $(Get-Command go -ErrorAction SilentlyContinue).Path, [string]$(go version)) -ForegroundColor Gray
       go get -t -x -tags mage,build,integration -v ./...
    displayName: go-get
    workingDirectory: ${{ parameters.WorkingDirectory }}
    condition: eq(variables['Agent.OS'], 'Windows_NT')
    failOnStderr: false
  # ##############
  # # NonWindows #
  # ##############
  # - pwsh: |
  #     try {
  #       # $ENV:PATH="${ENV:HOME}/.local/share/aquaproj-aqua/bin:${PATH}"
  #       $ENV:PATH="$(Build.SourcesDirectory)/.cache/aqua/bin:${PATH}"
  #       Write-Host "Go binary used: $((Get-Command go -ErrorAction SilentlyContinue).Path)"
  #       go mod download -x
  #       exit 0
  #     }
  #     catch {
  #       throw
  #       exit 1
  #     }
  #   displayName: go-mod-download
  #   # condition: and(succeeded(), eq(variables.VENDORED, '0' )) # Only proceed with caching if vendoring is false
  #   workingDirectory: ${{ parameters.WorkingDirectory }}
  #   condition: ne(variables['Agent.OS'], 'Windows_NT')
  #   failOnStderr: false # go gives false errors on this

  # - pwsh: |
  #     try {
  #       $ENV:PATH = '$(Build.SourcesDirectory)/.cache/aqua/bin', $ENV:PATH -join [IO.Path]::PathSeparator
  #       # # $ENV:PATH="${ENV:HOME}/.local/share/aquaproj-aqua/bin:${PATH}"
  #       # $ENV:PATH="$(Build.SourcesDirectory)/.cache/aqua/bin:${PATH}"
  #       Write-Host "Go binary used: $((Get-Command go -ErrorAction SilentlyContinue).Path)"
  #       go get -t -x -tags mage,build,integration -v ./...
  #       exit 0
  #     }
  #     catch {
  #       throw
  #       exit 1
  #     }
  #   displayName: go-get
  #   # condition: and(succeeded(), eq(variables.VENDORED, '0' )) # Only proceed with caching if vendoring is false
  #   workingDirectory: ${{ parameters.WorkingDirectory }}
  #   condition: ne(variables['Agent.OS'], 'Windows_NT')
  #   failOnStderr: false # go gives false errors on this
