---
parameters:
  - name: workingDirectory
    type: string
    default: $(System.DefaultWorkingDirectory)
  - name: aquaInstallMethod
    type: string
    default: '--only-link'
  - name: aquaInstallTags
    type: string
    default: '--tags ci'
  - name: AQUA_GITHUB_TOKEN
    type: string
    default: ''
steps:
  - bash: |
      mkdir -p '$(Build.SourcesDirectory)/.cache/aqua/aqua' &>/dev/null || true
      curl -sSfL https://raw.githubusercontent.com/aquaproj/aqua-installer/v1.1.2/aqua-installer | bash -s -- -i "$(Build.SourcesDirectory)/.cache/aqua/aqua"
      echo "##vso[task.prependpath]$(Build.SourcesDirectory)/.cache/aqua/bin"
      echo "##vso[task.setvariable variable=AQUA_ROOT_DIR]$(Build.SourcesDirectory)/.cache/aqua"
      echo "Configured AQUA_ROOT_DIR to the Agent.ToolsDirectory: $(Build.SourcesDirectory)/.cache/aqua"
      # echo "Added ${AQUA_PACKAGE_BIN} to PATH"
    displayName: install-aqua
    condition: ne(variables['Agent.OS'], 'Windows_NT')
    env:
      AQUA_GITHUB_TOKEN: ${{ parameters.AQUA_GITHUB_TOKEN }}
  - bash: |
      $(Build.SourcesDirectory)/.cache/aqua/aqua install ${{ parameters.aquaInstallMethod }} ${{ parameters.aquaInstallTags }}
    displayName: aqua-install
    workingDirectory: ${{ parameters.workingDirectory }}
    env:
      AQUA_LOG_LEVEL: debug
